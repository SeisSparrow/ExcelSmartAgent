# 📊 数据可视化指南

Excel Smart Agent 的图表自动优化功能说明。

---

## ⚠️ 重要更新：图表畸形问题已修复

如果您遇到图表X轴标签密集重叠、数据挤在一侧等畸形问题（特别是在"分析各地区销售趋势"等大量日期数据查询时），请参考：

📖 **[可视化图表畸形问题修复指南](VISUALIZATION_FIX_GUIDE.md)**

该文档详细说明了：
- 问题的根源（日期标签过多导致重叠）
- 完整的解决方案（使用AutoDateLocator和DateFormatter）
- 示例代码（examples/correct_visualization_example.py）
- 数据聚合策略（按周/月汇总）

**已实施的修复**：系统提示词已更新，新生成的代码应该会自动包含修复措施。

---

## ✨ 自动优化功能

系统会自动为生成的图表添加以下优化：

### 1. 中文字体支持 ✅

所有图表自动配置中文字体，支持 **macOS、Windows 和 Linux** 系统：
```python
plt.rcParams['font.sans-serif'] = [
    # Linux常用字体
    'Noto Sans CJK SC', 'WenQuanYi Micro Hei', 'Droid Sans Fallback',
    # macOS字体
    'PingFang SC', 'Heiti SC', 'STHeiti',
    # Windows字体
    'SimHei', 'Microsoft YaHei',
    # 通用备选
    'Arial Unicode MS', 'sans-serif'
]
plt.rcParams['axes.unicode_minus'] = False
```

**效果**：
- ✅ 标题正常显示：`销售额趋势图`
- ✅ 轴标签显示：`日期`、`销售额（万元）`
- ❌ 之前显示：`□□□□□`

**Ubuntu/Linux 用户**：如果中文仍然无法显示，请安装中文字体：
```bash
# Ubuntu/Debian
sudo apt-get install fonts-noto-cjk fonts-wqy-microhei

# CentOS/RHEL
sudo yum install google-noto-sans-cjk-fonts wqy-microhei-fonts

# 安装后清除matplotlib缓存
rm -rf ~/.cache/matplotlib
```

---

### 2. X轴标签优化 ✅

当X轴有大量标签时（如日期、产品名称），自动优化显示：

#### 方法 A: 标签旋转（默认）
```python
plt.xticks(rotation=45, ha='right')
```

**适用场景**：
- 日期时间序列
- 较长的分类名称
- 10-100个数据点

**效果**：
```
         2024-01-01
                   2024-01-15
                             2024-02-01
```

#### 方法 B: 智能抽样（大数据量）
当数据点超过30个时，自动抽取显示：
```python
if len(df) > 30:
    step = len(df) // 20
    plt.xticks(range(0, len(df), step), ...)
```

**适用场景**：
- 超过100个数据点
- 每日数据的年度分析
- 高频数据可视化

**效果**：只显示约20个均匀分布的标签

#### 方法 C: 日期自动格式化
对于时间序列数据：
```python
import matplotlib.dates as mdates
plt.gca().xaxis.set_major_formatter(mdates.DateFormatter('%Y-%m-%d'))
plt.gcf().autofmt_xdate()
```

---

### 3. 图表尺寸优化 ✅

根据数据量自动调整图表尺寸：

| 数据点数量 | 推荐尺寸 | 说明 |
|-----------|---------|------|
| < 20 | (10, 6) | 标准尺寸 |
| 20-50 | (12, 6) | 稍宽 |
| 50-100 | (14, 6) | 较宽 |
| > 100 | (16, 8) | 超宽 |

---

## 🎯 查询建议

### 时间序列分析

**推荐查询**：
```
✅ "画出销售额随时间的趋势图"
✅ "显示每天的销售额变化"
✅ "分析最近3个月的销售趋势"
```

**AI会自动**：
- 旋转日期标签
- 格式化日期显示
- 调整图表宽度
- 添加网格线

### 分类数据分析

**推荐查询**：
```
✅ "显示各产品的销售额柱状图"
✅ "比较不同地区的销售情况"
✅ "显示销售额前20名的产品"
```

**AI会自动**：
- 旋转长标签
- 限制显示数量
- 排序数据
- 添加数值标注

### 对比分析

**推荐查询**：
```
✅ "对比今年和去年的销售额"
✅ "显示各地区销售额占比饼图"
✅ "绘制销售额和利润的双轴图"
```

---

## 💡 最佳实践

### 1. 明确指定图表类型

❌ 模糊：`"分析销售数据"`
✅ 清晰：`"用折线图显示销售趋势"`

### 2. 限制数据范围

对于大数据集，指定范围：
```
✅ "显示前10名产品的销售额"
✅ "分析最近30天的数据"
✅ "显示销售额超过10万的记录"
```

### 3. 指定时间粒度

时间序列分析时明确粒度：
```
✅ "按月统计销售额"
✅ "显示每周的销售趋势"
✅ "按季度汇总数据"
```

### 4. 使用合适的图表类型

| 场景 | 推荐图表 | 查询示例 |
|------|---------|---------|
| 趋势变化 | 折线图 | "画折线图显示趋势" |
| 数量对比 | 柱状图 | "用柱状图对比销售额" |
| 占比分布 | 饼图 | "显示各地区占比饼图" |
| 相关性 | 散点图 | "绘制价格与销量的散点图" |
| 多维对比 | 分组柱状图 | "对比各地区各产品的销售" |

---

## 🔧 手动优化

如果自动生成的图表还需要调整，可以在查询中明确说明：

### 调整标签角度
```
"画销售趋势图，X轴标签垂直显示"
"画柱状图，标签旋转90度"
```

### 调整图表尺寸
```
"画一个宽度为16的销售趋势图"
"生成超宽的销售对比图"
```

### 调整标签显示
```
"只显示每5天的日期标签"
"画趋势图，只标注月初日期"
```

### 自定义样式
```
"用深色主题画趋势图"
"生成简洁风格的柱状图"
"画专业的销售报表图"
```

---

## 📈 示例对比

### 问题：日期标签重叠

**查询**：`"画出每天的销售额趋势"`

**之前的问题**：
- ❌ 所有日期标签水平显示
- ❌ 标签密集重叠
- ❌ 完全无法辨认

**现在的效果**：
- ✅ 标签自动旋转45度
- ✅ 使用日期格式化
- ✅ 自动调整显示密度
- ✅ 清晰可读

### 问题：分类名称过长

**查询**：`"显示各产品的销售额"`

**之前的问题**：
- ❌ 产品名称水平显示被截断
- ❌ 标签相互遮挡

**现在的效果**：
- ✅ 产品名称旋转显示
- ✅ 图表宽度自动调整
- ✅ 所有名称完整显示

---

## 🎨 支持的可视化库

### Matplotlib / Seaborn（推荐）

**优势**：
- ✅ 完全支持中文
- ✅ 自动优化X轴
- ✅ 丰富的图表类型
- ✅ 高度可定制

**适用场景**：
- 统计图表
- 科学可视化
- 报告导出

### Plotly（交互式）

**优势**：
- ✅ 支持交互式操作
- ✅ 自动处理标签
- ✅ 现代化外观

**适用场景**：
- 需要缩放、悬停提示
- 动态数据探索
- Web展示

---

## ❓ 常见问题

### Q: 标签还是看不清怎么办？

A: 尝试在查询中说明：
```
"画趋势图，标签旋转60度"
"只显示每10天的日期"
"增大图表宽度"
```

### Q: 能否隐藏部分标签？

A: 可以在查询中指定：
```
"画趋势图，只显示月初的日期"
"每隔5个数据点显示一个标签"
```

### Q: 如何调整日期格式？

A: 在查询中说明：
```
"用'年-月'格式显示日期"
"日期只显示月份和日期"
```

### Q: 图表能保存吗？

A: 图表会以PNG格式嵌入在结果中，可以：
- 右键图片 → 另存为
- 截图保存
- 复制粘贴到文档

---

## 📚 相关文档

- [快速开始](QUICKSTART.md) - 基础使用指南
- [故障排除](TROUBLESHOOTING.md) - 常见问题解决
- [README](README.md) - 项目总览

---

**提示**：系统会根据数据特征自动选择最佳的可视化策略，大多数情况下您无需手动调整！🎉


